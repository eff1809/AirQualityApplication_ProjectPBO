<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>AirPulse • Dark Mode</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- DARK MODE PALETTE (Tetap Sama) --- */
        :root {
            --primary: #3b82f6;
            --primary-glow: rgba(59, 130, 246, 0.5);
            --background: #0f172a;
            --surface: #1e293b;
            --surface-hover: #334155;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --radius: 20px;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--background);
            color: var(--text-main);
            overflow-x: hidden;
        }

        .bg-decoration { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; overflow: hidden; }
        .blob { position: absolute; filter: blur(100px); opacity: 0.4; z-index: -1; }
        .blob-1 { top: -20%; left: -10%; width: 600px; height: 600px; background: #4f46e5; border-radius: 50%; }
        .blob-2 { bottom: -20%; right: -10%; width: 700px; height: 700px; background: #0ea5e9; border-radius: 50%; }

        .navbar { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); padding: 1.2rem 0; }
        .navbar-brand { color: var(--text-main) !important; font-weight: 800; font-size: 1.5rem; letter-spacing: -0.5px; }
        .brand-icon { background: linear-gradient(135deg, var(--primary), #8b5cf6); color: white; width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 15px var(--primary-glow); }

        .glass-card { background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--card-shadow); transition: all 0.3s ease; }
        .glass-card:hover { transform: translateY(-5px); border-color: rgba(255,255,255,0.2); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.6); }

        .search-input { background: var(--surface); border: 1px solid var(--border); color: var(--text-main); padding: 1.2rem 1.5rem 1.2rem 3.5rem; border-radius: 50px; font-size: 1.1rem; width: 100%; transition: all 0.3s; }
        .search-input::placeholder { color: var(--text-sub); }
        .search-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2); background: #0f172a; }
        .search-icon { position: absolute; left: 1.2rem; top: 50%; transform: translateY(-50%); color: var(--text-sub); }
        .search-btn { position: absolute; right: 6px; top: 6px; bottom: 6px; border-radius: 40px; padding: 0 30px; background: var(--primary); border: none; color: white; font-weight: 600; }
        .search-btn:hover { background: #2563eb; box-shadow: 0 0 15px var(--primary-glow); }

        .text-sub { color: var(--text-sub); }
        .text-glow { text-shadow: 0 0 20px rgba(255,255,255,0.3); }

        .aqi-main { padding: 3rem 2rem; color: white; text-align: center; position: relative; overflow: hidden; }
        .bg-good { background: linear-gradient(135deg, #059669, #047857); }
        .bg-fair { background: linear-gradient(135deg, #d97706, #b45309); }
        .bg-moderate { background: linear-gradient(135deg, #ea580c, #c2410c); }
        .bg-poor { background: linear-gradient(135deg, #dc2626, #b91c1c); }
        .bg-hazardous { background: linear-gradient(135deg, #7c3aed, #6d28d9); }
        .aqi-main::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at top right, rgba(255,255,255,0.2), transparent); pointer-events: none; }

        .metric-value { font-size: 2rem; font-weight: 700; color: var(--text-main); }
        .metric-unit { color: var(--text-sub); font-size: 0.9rem; }
        .progress { background-color: #334155; border-radius: 10px; }

        .tips-container { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); }
        .tip-icon-box { background: var(--primary); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        footer { border-top: 1px solid var(--border); margin-top: 3rem; padding-top: 2rem; }
    </style>
</head>
<body>

<div class="bg-decoration">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
</div>

<nav class="navbar sticky-top">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center gap-2" href="/">
            <div class="brand-icon"><i class="bi bi-cloud-lightning-rain-fill"></i></div>
            <span>AirPulse<span style="color: var(--primary)">.io</span></span>
        </a>
        <div class="d-flex gap-2">
            <span class="badge bg-dark border border-secondary text-light px-3 py-2 rounded-pill">Dark Mode Active</span>
        </div>
    </div>
</nav>

<div class="container py-5">
    
    <div class="row justify-content-center mb-5">
        <div class="col-lg-7 text-center">
            <h2 class="fw-bold mb-2 text-glow">Monitoring Udara Real-Time</h2>
            <p class="text-sub mb-4">Data real-time akurat untuk menjaga kesehatan keluarga anda</p>
            <form action="/" method="get" style="position: relative;">
                <i class="bi bi-search search-icon"></i>
                <input type="text" name="city" class="search-input shadow-lg" placeholder="Cari lokasi (contoh: Jakarta, Delhi)..." th:value="${city}">
                <button type="submit" class="btn search-btn">Scan</button>
            </form>
        </div>
    </div>

    <div th:if="${isDanger}" class="alert alert-dismissible fade show shadow-lg mb-5" role="alert" 
         style="background: rgba(220, 38, 38, 0.15); border: 1px solid #dc2626; color: #fca5a5;">
        <div class="d-flex align-items-center">
            <i class="bi bi-radioactive fs-2 me-3"></i>
            <div>
                <h4 class="alert-heading fw-bold">PERINGATAN KRITIS</h4>
                <p class="mb-0">Terdeteksi polusi berbahaya di <strong th:text="${city}"></strong>. Wajib gunakan masker N95.</p>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5 " th:if="${current != null}">
        <div class="col-lg-4">
            <div class="glass-card h-100 aqi-main"
                 th:classappend="${current.aqiIndex == 1 ? 'bg-good' : (current.aqiIndex == 2 ? 'bg-good' : (current.aqiIndex == 3 ? 'bg-fair' : (current.aqiIndex == 4 ? 'bg-poor' : 'bg-hazardous')))}">
                
                <div class="d-flex justify-content-between w-100 mb-3 align-items-start">
                    <span class="badge bg-black bg-opacity-25 rounded-pill backdrop-blur d-flex align-items-center gap-2">
                        <i class="bi bi-broadcast animate-pulse"></i> Live
                    </span>

                    <div class="text-end bg-black bg-opacity-20 px-3 py-1 rounded-4 backdrop-blur d-flex align-items-center gap-2">
                        <img th:src="'https://openweathermap.org/img/wn/' + ${current.weatherIcon} + '.png'" 
                             alt="Weather" style="width: 30px; height: 30px;">
                        
                        <div>
                            <div class="fw-bold lh-1" style="font-size: 1.1rem;">
                                <span th:text="${#numbers.formatDecimal(current.temperature, 1, 0)}">28</span>°C
                            </div>
                        </div>
                    </div>
                </div>

                <div class="display-1 fw-bold mb-0" th:text="${current.aqiIndex}">1</div>
                <div class="h4 text-uppercase fw-bold opacity-90 mb-3" th:text="${current.status}">BAIK</div>
                
                <div class="d-inline-block bg-white bg-opacity-10 px-4 py-2 rounded-pill backdrop-blur mt-2">
                    <i class="bi bi-geo-alt-fill me-2"></i> <span th:text="${city}">City</span>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="glass-card p-4 h-100">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-sub fw-bold text-uppercase"><i class="bi bi-virus me-2"></i>PM 2.5</span>
                            <i class="bi bi-info-circle text-sub"></i>
                        </div>
                        <div class="d-flex align-items-baseline gap-2">
                            <span class="metric-value" th:text="${current.pm25}">12.5</span>
                            <span class="metric-unit">µg/m³</span>
                        </div>
                        <div class="progress mt-3" style="height: 6px;">
                            <div class="progress-bar bg-primary" style="width: 25%"></div>
                        </div>
                        <div>
                            <small class="text-sub">Debu halus yang dapat masuk ke paru-paru</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="glass-card p-4 h-100">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-sub fw-bold text-uppercase"><i class="bi bi-fuel-pump me-2"></i>CO Level</span>
                            <i class="bi bi-info-circle text-sub"></i>
                        </div>
                        <div class="d-flex align-items-baseline gap-2">
                            <span class="metric-value" th:text="${current.co2}">240</span>
                            <span class="metric-unit">µg/m³</span>
                        </div>
                        <div class="progress mt-3" style="height: 6px;">
                            <div class="progress-bar bg-warning" style="width: 45%"></div>
                        </div>
                        <div>
                            <small class="text-sub"> Gas hasil pembakaran kendaraan bermotor</small>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="glass-card tips-container p-4 d-flex align-items-center gap-4">
                        <div class="tip-icon-box flex-shrink-0">
                            <i class="bi bi-stars fs-5"></i>
                        </div>
                        <div>
                            <h5 class="fw-bold text-primary mb-1">Tips Hari Ini</h5>
                            <p class="mb-0 text-sub" id="dailyTip">Menganalisis kondisi lingkungan...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="glass-card p-4 p-md-5 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold mb-0 text-main">Riwayat & Tren</h4>
                <p class="text-sub mb-0">Analisis pergerakan polutan dalam 24 jam terakhir</p>
            </div>
            <a th:href="@{/export(city=${city})}" class="btn btn-outline-light btn-sm rounded-pill px-3">
                <i class="bi bi-download me-2"></i>Download CSV
            </a>
        </div>
        <div class="chart-container">
            <canvas id="historyChart"></canvas>
        </div>
    </div>

    <footer class="text-center text-sub small pb-4">
        <p class="mb-1">&copy; 2025 AirPulse Dark. Designed for Sustainability.</p>
    </footer>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    /*
        LOGIC AI INSIGHT (Rule-Based System)
        Menggunakan logika percabangan (if-else) untuk menentukan tips
        berdasarkan index AQI yang didapat dari server.
        Ini mensimulasikan keputusan "cerdas" namun tetap menggunakan
        algoritma dasar yang wajar untuk mahasiswa.
    */
    
    // Ambil nilai AQI dari Thymeleaf (Server-side rendering)
    // Jika data null (misal belum search), set default ke 1 (Baik)
    var currentAqi = [[${current != null ? current.aqiIndex : 1}]];
    
    let recommendedTips = [];

    // Logika Penentuan Tips (Context Aware)
    if (currentAqi === 1) {
        // AQI 1: Baik (Good)
        recommendedTips = [
            "Udara sangat bersih! Waktu yang tepat untuk jogging di luar ruangan.",
            "Buka jendela rumah lebar-lebar agar sirkulasi udara segar masuk.",
            "Kondisi sempurna untuk mengajak anak-anak bermain di taman."
        ];
    } else if (currentAqi === 2) {
        // AQI 2: Layak (Fair)
        recommendedTips = [
            "Kualitas udara cukup baik, aman untuk aktivitas normal.",
            "Kelompok sensitif (asma) sebaiknya tetap waspada meski udara terlihat bersih.",
            "Nikmati udara luar, tapi hindari area pinggir jalan raya yang macet."
        ];
    } else if (currentAqi === 3) {
        // AQI 3: Sedang (Moderate)
        recommendedTips = [
            "Kurangi olahraga berat di luar ruangan jika Anda memiliki riwayat asma.",
            "Sebaiknya tutup jendela jika angin membawa debu dari jalanan.",
            "Gunakan masker kain jika Anda merasa sensitif terhadap debu hari ini."
        ];
    } else if (currentAqi === 4) {
        // AQI 4: Buruk (Poor)
        recommendedTips = [
            "Udara tidak sehat! Wajib gunakan masker saat keluar rumah.",
            "Tutup ventilasi rumah dan nyalakan Air Purifier jika ada.",
            "Hindari mengajak anak-anak atau lansia beraktivitas di luar ruangan."
        ];
    } else {
        // AQI 5: Sangat Buruk (Hazardous)
        recommendedTips = [
            "BAHAYA! Hindari semua aktivitas di luar ruangan.",
            "Gunakan masker N95 (bukan masker kain) jika terpaksa keluar.",
            "Segera masuk ke ruangan tertutup yang memiliki penyaring udara.",
            "Jaga kebersihan udara dalam ruangan, jangan merokok atau membakar lilin."
        ];
    }

    // Pilih 1 tips secara acak dari kategori yang relevan
    // Ini membuat aplikasi terasa dinamis (tidak selalu menampilkan teks yang sama)
    const selectedTip = recommendedTips[Math.floor(Math.random() * recommendedTips.length)];
    
    // Tampilkan ke HTML
    document.getElementById("dailyTip").innerText = selectedTip;


    /* --- CHART LOGIC (Tetap Sama) --- */
    var historyData = [[${history}]];
    
    if (historyData && historyData.length > 0) {
        historyData.reverse();
        
        const labels = historyData.map(d => {
            const date = new Date(d.timestamp);
            return date.getHours() + ":" + (date.getMinutes()<10?'0':'') + date.getMinutes();
        });
        const pm25Data = historyData.map(d => d.pm25);
        const aqiData = historyData.map(d => d.aqiIndex);

        const ctx = document.getElementById('historyChart').getContext('2d');
        let gradientFill = ctx.createLinearGradient(0, 0, 0, 400);
        gradientFill.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
        gradientFill.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'PM 2.5 (µg/m³)',
                        data: pm25Data,
                        borderColor: '#3b82f6',
                        backgroundColor: gradientFill,
                        borderWidth: 3,
                        pointBackgroundColor: '#1e293b',
                        pointBorderColor: '#3b82f6',
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'AQI',
                        data: aqiData,
                        borderColor: '#10b981',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { labels: { color: '#f8fafc' } },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.9)',
                        titleColor: '#f8fafc',
                        bodyColor: '#cbd5e1',
                        borderColor: 'rgba(255,255,255,0.1)',
                        borderWidth: 1,
                        padding: 12
                    }
                },
                scales: {
                    y: {
                        position: 'left',
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        title: { display: true, text: 'PM 2.5 Concentration' }
                    },
                    y1: {
                        position: 'right',
                        grid: { display: false },
                        min: 0, max: 5,
                        title: { display: true, text: 'AQI Level' }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    }
</script>

<script th:inline="javascript">
    /* --- LOGIC NOTIFIKASI & MONITORING OTOMATIS   --- */

    var isDanger = [[${isDanger}]];
    var city = [[${city}]];
    var aqi = [[${current != null ? current.aqiIndex : 0}]];

    // 1. Minta Izin Notifikasi
    function requestNotificationPermission() {
        if ("Notification" in window && Notification.permission !== "granted") {
            Notification.requestPermission();
        }
    }

    // 2. Tampilkan Notifikasi (Bisa muncul di atas tab lain)
    function showDangerNotification() {
        if (Notification.permission === "granted" && isDanger) {
            const notification = new Notification("⚠️ PERINGATAN BAHAYA UDARA!", {
                body: `Kualitas udara di ${city} memburuk (AQI: ${aqi}). Segera pakai masker!`,
                icon: "https://cdn-icons-png.flaticon.com/512/564/564619.png",
                requireInteraction: true // Notif tidak hilang sendiri 
            });
            
            // Kalau notif diklik, kembali ke tab aplikasi
            notification.onclick = function() {
                window.focus();
                this.close();
            };
        }
    }

    // 3. LOGIC LIVE MONITORING (Auto-Refresh)
    // Cek apakah ada kota yang sedang dicari/dipantau
    if (city && city !== 'null' && city !== '') {
        // Set timer: Refresh halaman setiap 60 detik (60000 ms)
        // Ubah angka ini jadi 10000 (10 detik) KHUSUS SAAT DEMO
        setTimeout(function() {
            console.log("Melakukan pengecekan udara otomatis...");
            window.location.reload(); 
        }, 60000); // <-- akan kita ganti 60000 jadi 10000 saat demo depan dosen (biar cepat kelihatan)
    }

    document.addEventListener('DOMContentLoaded', function() {
        requestNotificationPermission();
        
        // Beri jeda 2 detik sebelum notifikasi muncul agar terlihat natural
        setTimeout(showDangerNotification, 2000);   
    });
</script>
</body>
</html>